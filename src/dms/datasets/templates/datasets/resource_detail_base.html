{% extends 'app.html' %}
{% load rules %}
{% load static %}
{% load language_tags %}
{% load i18n %}
{% load utils %}

{% block article %}

<div class="flex items-center justify-between">
    <div>
        <h1 class="text-4xl font-bold">{{ object }}</h1>
        <p class="text-sm text-gray-700">
            Created at: {{object.created_at}} &bull;
            Last Modified: {{object.last_modified_at}}
        </p>
        <div class="flex gap-1">
            {% for tag in object.tags.all %}
            <div class="badge badge-info">{{ tag }}</div>
            {% endfor %}
        </div>
    </div>
    <div class="flex gap-4">
        <a class="btn btn-primary" href="{% url 'datasets:dataset_detail' pk=object.dataset_id %}">Dataset</a>

        {% has_perm 'datasets.change_resource' user object as can_change %}
        {% if can_change %}
        <a class="btn btn-primary" href="{{ object.edit_url }}">Edit</a>
        <a class="btn btn-secondary"
            href="{% url 'datasets:resource_convert' dataset_pk=object.dataset_id pk=object.pk %}">Change resource
            type</a>
        {% if not object.is_metadata_manual %}
        <c-action_form action="{% url 'datasets:resource_refresh_metadata' dataset_pk=object.dataset_id pk=object.pk %}"
            class="btn text-white">
            Refresh Metadata
        </c-action_form>
        {% endif %}
        {% endif %}
        {% has_perm 'datasets.delete_resource' user object as can_delete %}
        {% if can_delete %}
        <a class="btn btn-error text-error-content"
            href="{% url 'datasets:resource_delete' dataset_pk=object.dataset_id pk=object.pk %}">Delete</a>
        {% endif %}
    </div>
</div>

<p class="mt-5">Resource path: <a href="{{ object.uri }}">{{ object.uri }}</a></p>
<p class="mt-2">Role: <em>{{ object.role|default_if_none:'Not defined' }}</em></p>
<p class="mt-2">Access type: <em>{{ object.access_type }}</em></p>

<c-accordion type='multiple'
    open="{'meta': true, 'preview': true , 'schema': true, 'snippets': true, 'map': true, 'data': true, 'desc': true, 'user-meta': true}" class="mt-4">
    {% if object.extent %}
    <c-accordion.item value='desc'>
        <c-accordion.trigger value='desc' class="text-2xl font-bold">Description</c-accordion.trigger>
        <c-accordion.content value='desc'>
            <div>{{object.description|markdown}}</div>
        </c-accordion.content>
    </c-accordion.item>
    <c-accordion.item value='map'>
        <c-accordion.trigger value='map' class="text-2xl font-bold">Spatial Extent</c-accordion.trigger>
        <c-accordion.content value='map'>
            {% include 'datasets/partials/maplibre.html' with url=FEATURE_URL map_height="400px" %}
        </c-accordion.content>
    </c-accordion.item>
    {% endif %}
    {% if object.metadata %}
    <c-accordion.item value='meta'>
        <c-accordion.trigger value='meta' class="text-2xl font-bold">GDAL Metadata</c-accordion.trigger>
        <c-accordion.content value='meta'>
            {% if object.is_metadata_manual %}
            <div class="alert alert-warning mb-4">
                This metadata has been manually created or edited and are not be updated automatically.
                This could mean that they are incomplete, outdated or could even use a different schema.
            </div>
            {% endif %}
            {{ metadata_preview|safe }}
        </c-accordion.content>
    </c-accordion.item>
    {% endif %}
    {% if not object.is_metadata_manual %}
    <c-accordion.item value='meta'>
        <c-accordion.trigger value='meta' class="text-2xl font-bold">Last sync</c-accordion.trigger>
        <c-accordion.content value='meta'>
            <c-json-object-viewer :dict="object.last_sync"></c-json-object-viewer>
        </c-accordion.content>
    </c-accordion.item>
    {% endif %}
    {% if object.user_metadata %}
    <c-accordion.item value='user-meta'>
        <c-accordion.trigger value='user-meta' class="text-2xl font-bold">Manully provided Metadata</c-accordion.trigger>
        <c-accordion.content value='user-meta'>
            {{ user_metadata_preview|safe }}
        </c-accordion.content>
    </c-accordion.item>
    {% endif %}
    {% if snippets %}
    <c-accordion.item value='snippets'>
        <c-accordion.trigger value='snippets' class="text-2xl font-bold">Snippets</c-accordion.trigger>
        <c-accordion.content value='snippets'>
            <c-tabs default_value="{{ snippets_default }}">
                <c-tabs.list>
                    {% for snippet in snippets %}
                    <c-tabs.trigger value='{{ snippet.template }}'>{{ snippet.title }}</c-tabs.trigger>
                    {% endfor %}
                </c-tabs.list>
                {% for snippet in snippets %}
                <c-tabs.content value='{{ snippet.template }}' id="{{ snippet.template }}-code">
                    <pre>
                        <code class="language-{{snippet.lang}}">
{% include snippet.template with uri=object.uri spatial=snippet.spatial %}
                        </code>
                    </pre>
                </c-tabs.content>
                {% endfor %}
            </c-tabs>
        </c-accordion.content>
    </c-accordion.item>
    {% endif %}
    {% block resource_specific_content %}
    {% endblock resource_specific_content %}
</c-accordion>

{% endblock article %}

{% block body_javascript %}
{{ block.super }}
{% if snippets %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/r.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/sql.min.js"></script>
<script>hljs.highlightAll();</script>
{% endif %}
{% endblock body_javascript %}
