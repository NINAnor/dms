{% extends 'datasets/resource_detail_base.html' %}
{% load static %}
{% load render_table from django_tables2 %}


{% block resource_specific_content %}
{% if data_table %}
<c-accordion.item value='data'>
    <c-accordion.trigger value='data' class="text-2xl font-bold">Data Tables and Layers</c-accordion.trigger>
    <c-accordion.content value='data'>
        {% render_table data_table %}
    </c-accordion.content>
</c-accordion.item>
{% endif %}
{% if object.metadata.driverShortName == 'Parquet' and not object.dataset.under_embargo %}
<c-accordion.item value='preview'>
    <c-accordion.trigger value='preview' class="text-2xl font-bold">Preview</c-accordion.trigger>
    <c-accordion.content value='preview'>
        <iframe id="parquet-preview" style="width:100%; height:800px; border:none;" loading="lazy">
        </iframe>
    </c-accordion.content>
</c-accordion.item>
<script>
    const query = btoa(document.getElementById('datasets/snippets/duckdb-sql-code').textContent.trim());
    const title = "{{ object.title }} - {{ object.id }}";
    const params = new URLSearchParams({
        query: query,
        execute: 'true',
        title: title
    });

    const iframeElement = document.getElementById('parquet-preview');
    const iframeUrl = "{{ DUCKUI_URL }}?" + params.toString();

    // Use Intersection Observer to load iframe lazily when visible
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !iframeElement.src) {
                iframeElement.src = iframeUrl;
                observer.unobserve(iframeElement);
            }
        });
    });

    observer.observe(iframeElement);
</script>
{% endif %}
{% endblock resource_specific_content %}
